<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>ちいたん ユーザガイド</title>

<link rel="stylesheet" type="text/css" media="all" href="css/userguide.css" />
<link rel="stylesheet" type="text/css" media="all" href="css/site.css" />

<meta http-equiv="expires" content="-1" />
<meta http-equiv="pragma" content="no-cache" />
<meta name="robots" content="all" />

</head>
<body>

<!-- START NAVIGATION -->
<div id="nav"><div id="nav_inner"></div></div>
<div id="nav2"><a name="top"><br /></a></div>
<div id="masthead">
<table cellpadding="0" cellspacing="0" border="0" style="width:100%">
<tr>
<td><h1>ちいたん ユーザガイド Version 0.8.1.0</h1></td>
<td id="breadcrumb_right"><a href="toc.html">目次</a></td>
</tr>
</table>
</div>
<!-- END NAVIGATION -->


<!-- START BREADCRUMB -->
<table cellpadding="0" cellspacing="0" border="0" style="width:100%">
<tr>
<td id="breadcrumb">
<a href="javascript:void(0);">ホーム</a> &nbsp;&#8250;&nbsp;
<a href="index.html">ユーザガイド ホーム</a> &nbsp;&#8250;&nbsp;
モデル
</td>
</tr>
</table>
<!-- END BREADCRUMB -->

<br clear="all" />



<!-- START CONTENT -->
<div id="content">


<h1>モデル</h1>

<p>
データベースのテーブルをモデルによって簡単に操作します。
</p>

<h2>モデルの作成</h2>

<p>
以下が最小構成のモデルです。
<kbd>テーブル名.php</kbd>で作成し、テーブル名の一文字目を大文字にして以下を小文字にし、<var>C</var>をつけたものをクラス名とします。
</p>

<h3>user.php</h3>

<pre>
&lt;?php
class CUser extends CModel
{
}
?&gt;
</pre>


<h2>モデルの登録</h2>

<p>
フレームワークから呼ばれる<kbd>config_models</kbd>関数内でモデルを登録します。
</p>

<h3>config.php</h3>

<pre>
function config_database( &amp;$db )
{
	$db-&gt;add( '', 'localhost', 'user', 'password', 'dbname' );
	$db-&gt;add( 'special', '192.168.0.100', 'user', 'password', 'dbname' );
	$db-&gt;add( 'pg', 'localhost', 'user', 'password', 'dbname', DBKIND_PGSQL, '5432' );
}
</pre>

<pre>
function config_models( &amp;$controller )
{
	$controller-&gt;AddModel( 'user.php' );
	$controller-&gt;AddModel( 'specialuser.php', 'special' );
	$controller-&gt;AddModel( 'test.php', 'pg' );
}
</pre>


<h2>使用方法</h2>

<p>
モデルはコントローラにて呼び出します。
呼び出し方は以下の二つの方法があります。
上の方法はコントローラのメンバ変数と競合しない場合のみ設定されています。
</p>

<pre>
$c-&gt;user-&gt;function();
$c-&gt;m['user']-&gt;function();
</pre>


<h2>引数に使用するcondition</h2>

<p>
いくつかのメソッドの引数に<var>condition</var>がありますが、文字列によるSQLの記述の他に変数による指定も出来ます。
今のところ、結合は全て<strong>AND</strong>です。
これを使った場合、<var>value</var>は自動的にエスケープされます。
例えば以下の例はどちらも同じ機能になります。
</p>

<pre>
$c-&gt;user-&gt;find( 'id=1' );
$c-&gt;user-&gt;find( array( 'id' =&gt; 1 ) );
</pre>


<h2>関数</h2>

<ul>
<li>array find( [ mixed condition [, string order [, string limit [, string group]]] )</li>
<li>array findby( string field, string value [, string order [, string limit ]] )</li>
<li>array findone( [ string condition [, string order ]] )</li>
<li>array findoneby( string field, string value [, string order ] )</li>
<li>array findquery( string query [, string condition [, string order [, string limit [, string group ]]]] )</li>
<li>int getcount( [ string condition [, string limit ]] )</li>
<li>bool insert( array datas )</li>
<li>bool update( array datas )</li>
<li>bool updateby( array datas, string condition )</li>
<li>bool del( string condition )</li>
<li>result query( string query )</li>
<li>int GetLastInsertId()</li>
<li>int GetAffectedRows()</li>
<li>string GetLastError()</li>
<li>string to_datetime( [ int time ] )</li>
<li>string escape( string str )</li>
<li>bool validate( array datas )</li>
<li>string validatemsg( array datas )</li>
<li>array GetValidateError()</li>
<li>array describe()</li>
</ul>


<h3>array find( [ mixed <var>condition</var> [, string <var>order</var> [, string <var>limit</var> [, string <var>group</var> ]]] )</h3>

<p>
テーブルの中から<kbd>condition</kbd>と<kbd>order</kbd>、<kbd>limit</kbd>、<kbd>group</kbd>で指定されたものを配列として取得します。
</p>
<pre>
$results = $c-&gt;user-&gt;find( 'id='.$id, 'age DESC' );
</pre>


<h3>array findby( string <var>field</var>, string <var>value</var> [, string <var>order</var> [, string <var>limit</var> ]] )</h3>

<p>
テーブルから<kbd>field</kbd>と<kbd>value</kbd>、<kbd>order</kbd>、<kbd>limit</kbd>で指定されたものを配列として取得します。
</p>
<pre>
$results = $c-&gt;user-&gt;findby( 'user', 'name', 'id ASC' );
</pre>


<h3>array findone( [ string <var>condition</var> [, string <var>order</var> ]] )</h3>

<p>
テーブルの中から<kbd>condition</kbd>と<kbd>order</kbd>で指定されたものの先頭の一つを取得します。
</p>
<pre>
$result = $c-&gt;user-&gt;findone( 'id='.$id, 'age DESC' );
</pre>


<h3>array findoneby( string field, string value [, string order ] )</h3>

<p>
テーブルの中から<kbd>field</kbd>と<kbd>value</kbd>、<kbd>order</kbd>で指定されたものの先頭の一つを取得します。
</p>
<pre>
$result = $c-&gt;user-&gt;findone( 'id='.$id, 'age DESC' );
</pre>


<h3>array findquery( string <var>query</var> [, string <var>condition</var> [, string <var>order</var> [, string <var>limit</var> [, string <var>group</var> ]]]] )</h3>

<p>
リレーションを使用したい場合はこちらを利用します。
適合したレコードを配列にして取得します。
<kbd>query</kbd>にはWHERE句より前のクエリ文を指定します。
</p>
<pre>
$query = 'SELECT user.*, office.name FROM user LEFT JOIN user.office_id=office.id';
$results = $c-&gt;user-&gt;findquery( $query, 'age=24', 'age DESC' );
</pre>


<h3>int getcount( [ string <var>condition</var> [, string <var>limit</var> ]] )</h3>

<p>
テーブルの中の<kbd>condition</kbd>と<kbd>limit</kbd>で当てはまる要素の数を取得します。
</p>
<pre>
$count = $c-&gt;user-&gt;getcount( 'id='.$id, '10' );
</pre>


<h3>bool insert( array <var>datas</var> )</h3>

<p>
キーに要素名を指定して値を入れた配列を指定すると、その通りにINSERTを行います。
</p>
<pre>
$data['name'] = $name;
$data['email'] = $email;
$c-&gt;user-&gt;insert( $data );
</pre>


<h3>bool update( array <var>datas</var> )</h3>

<p>
キーに要素名を指定して値を入れた配列を指定すると、その通りにUPDATEを行います。
モデルのメンバ変数<var>$id</var>（デフォルト: <kbd>'id'</kbd>）と同じキーを見つけ、自動的にその場所をUPDATEします。
<var>$id</var>が見つからなかった場合は<var>FALSE</var>を返し処理を中止します。
</p>
<pre>
$data['id'] = $id;
$data['name'] = $name;
$data['email'] = $email;
$c-&gt;user-&gt;update( $data );
</pre>


<h3>bool updateby( array <var>datas</var>, string <var>condition</var> )</h3>

<p>
updateの様に自動的に条件を指定するのではなく、明示的に<kbd>condition</kbd>で条件を指定できます。
</p>
<pre>
$data['name'] = $name;
$data['email'] = $email;
$c-&gt;user-&gt;updateby( $data, 'age=25' );
</pre>


<h3>bool del( string <var>condition</var> )</h3>

<p>
<kbd>condition</kbd>で指定されたレコードを削除します。
</p>
<pre>
$c-&gt;user-&gt;del( 'age=25' );
</pre>


<h3>result query( string <var>query</var> )</h3>

<p>
直接クエリを送信します。
テーブル名は自動的には設定されませんので完全なクエリを指定します。
</p>
<pre>
$results = $c-&gt;user-&gt;query( &quot;SELECT * FROM user WHERE age='24' ORDER BY age DESC&quot; );
</pre>


<h3>int GetLastInsertId()</h3>

<p>
最後に挿入したIDを返します。（MySQLのみ）
</p>
<pre>
$lastId = $c-&gt;user-&gt;GetLastInsertId();
</pre>


<h3>int GetAffectedRows()</h3>

<p>
SQLで影響を受けた行の数を返します。
</p>
<pre>
$count = $c-&gt;user-&gt;GetAffectedRows();
</pre>


<h3>string GetLastError()</h3>

<p>
最後に得たエラーを返します。
</p>
<pre>
$error = $c-&gt;user-&gt;GetLastError();
</pre>


<h3>string to_datetime( [ int <var>time</var> ] )</h3>

<p>
指定されたUNIXタイムスタンプをDATETIMEの様式にフォーマットします。
（例: 2006-09-19 12:24:46）
</p>
<pre>
$date = $c-&gt;user-&gt;to_datetime();
</pre>


<h3>string escape( string <var>str</var> )</h3>

<p>
文字列をクエリ用にエスケープします。
</p>
<pre>
$query = $c-&gt;user-&gt;escape( $query );
</pre>


<h3>bool validate( array <var>datas</var> )<br />
string validatemsg( array <var>datas</var> )<br />
array GetValidateError()</h3>

<p>
これらはバリデート用関数です。
詳しくは<a href="validate.html">バリデート</a>のマニュアルをご覧下さい。
</p>


<h3>array describe()</h3>

<p>
テーブルのカラム情報を得ます。
</p>
<pre>
$columns = $c-&gt;user-&gt;describe();
</pre>



<h2>変数</h2>

<ul>
<li>var $id</li>
<li>var $name</li>
<li>var $table</li>
<li>var $controller</li>
</ul>


<h3>var $id</h3>

<p>
<var>$id</var>で指定された値（デフォルト: <kbd>'id'</kbd>）でテーブルの主要な要素を指定します。
update関数などで使用されます。
</p>


<h3>var $name</h3>

<p>
<var>$name</var>で指定された（デフォルト: <kbd>''</kbd>）データベース接続を使用してクエリを実行します。
</p>


<h3>var $table</h3>

<p>
何も指定されていない時（デフォルト）はファイル名のデータベースを自動的に指定します。
これを設定すると、指定されたテーブルにアクセスするようになります。
</p>


<h3>var $controller</h3>

<p>
コントローラを参照できます。
</p>


</div>
<!-- END CONTENT -->


<div id="footer">
<p>
前のトピック:&nbsp;&nbsp;<a href="tutorial.html">チュートリアル</a>
&nbsp;&nbsp;&nbsp;&middot;&nbsp;&nbsp;
<a href="model.html#top">ページトップ</a>&nbsp;&nbsp;&nbsp;&middot;&nbsp;&nbsp;
<a href="index.html">ユーザガイド ホーム</a>&nbsp;&nbsp;&nbsp;&middot;&nbsp;&nbsp;
次のトピック:&nbsp;&nbsp;<a href="view.html">ビュー</a>
</p>
<p><a href="http://php.cheetan.net/">Cheetan</a> &nbsp;&middot;&nbsp; Copyright &#169; 2006-2008 &nbsp;&middot;&nbsp; <a href="http://www.alphabrend.com/">Alphabrend</a><br />Powered by CodeIgniter Documents CSS.</p>
</div>

<script type="text/javascript"><!--
var fc2footerparam = 'charset=' + (document.charset ? document.charset : document.characterSet) + '&url=' + document.location + '&service=0&r=' + Math.floor(Math.random()*99999999999);
var fc2footertag = '<' + 'script src="//vip.chps-api.fc2.com/apis/footer/?' + fc2footerparam + '" charset="UTF-8"><' + '/script>';
document.write(fc2footertag);
//--></script>
<!-- FC2, inc.-->
<img src="http://media.fc2.com/counter_img.php?id=50" style="visibility:hidden" alt="inserted by FC2 system" width="0" height="0">
<!-- FC2, inc.-->
</body>
</html>
